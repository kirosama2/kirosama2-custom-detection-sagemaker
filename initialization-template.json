
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "SourceCodeZip": {
      "Type": "String",
      "Default": "https://codeload.github.com/aws-samples/amazon-sagemaker-custom-object-detection/zip/master"
    },
    "SourceCodeDirectory": {
      "Type": "String",
      "Default": "custom-object-detection-master"
    }
  },
  "Resources": {
    "CodeInitializer": {
      "Type": "Custom::CodeInitializer",
      "Version": "1.0",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt": [ "CodeInitializerFunction", "Arn" ] },
        "ProjectName": { "Ref": "AWS::StackName" },
        "SourceCodeZip": { "Ref": "SourceCodeZip" },
        "Region": { "Ref": "AWS::Region" },
        "BucketName": { "Ref": "ArtifactBucket" }
      }
    },
    "CodeInitializerFunction": {
      "DependsOn": [ "ArtifactBucket", "CodeBuildInitializerProject" ],
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": {
            "Fn::Join": [
              "\n",
              [
                "var response = require('cfn-response');",
                "var AWS = require('aws-sdk');",
                "var s3 = new AWS.S3();",
                "var codebuild = new AWS.CodeBuild();",
                "exports.handler = (event, context, callback) => {",
                "console.log(JSON.stringify(event));",
                "var bucket = event.ResourceProperties.BucketName;",
                "var objectKey = event.ResourceProperties.ProjectName + '/initialization.zip';",
                "var sourceCodeZipUrl = event.ResourceProperties.SourceCodeZip;",
                "if (event.RequestType == 'Delete')",
                "{",
                "s3.listObjects({Bucket: bucket, MaxKeys: 1000}).promise()",
                ".then(data => {",
                "var deleteTasks = [];",