
{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "SourceCodeZip": {
      "Type": "String",
      "Default": "https://codeload.github.com/aws-samples/amazon-sagemaker-custom-object-detection/zip/master"
    },
    "SourceCodeDirectory": {
      "Type": "String",
      "Default": "custom-object-detection-master"
    }
  },
  "Resources": {
    "CodeInitializer": {
      "Type": "Custom::CodeInitializer",
      "Version": "1.0",
      "Properties": {
        "ServiceToken": { "Fn::GetAtt": [ "CodeInitializerFunction", "Arn" ] },
        "ProjectName": { "Ref": "AWS::StackName" },
        "SourceCodeZip": { "Ref": "SourceCodeZip" },
        "Region": { "Ref": "AWS::Region" },
        "BucketName": { "Ref": "ArtifactBucket" }
      }
    },
    "CodeInitializerFunction": {
      "DependsOn": [ "ArtifactBucket", "CodeBuildInitializerProject" ],
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": {
            "Fn::Join": [
              "\n",
              [
                "var response = require('cfn-response');",
                "var AWS = require('aws-sdk');",
                "var s3 = new AWS.S3();",
                "var codebuild = new AWS.CodeBuild();",
                "exports.handler = (event, context, callback) => {",
                "console.log(JSON.stringify(event));",
                "var bucket = event.ResourceProperties.BucketName;",
                "var objectKey = event.ResourceProperties.ProjectName + '/initialization.zip';",
                "var sourceCodeZipUrl = event.ResourceProperties.SourceCodeZip;",
                "if (event.RequestType == 'Delete')",
                "{",
                "s3.listObjects({Bucket: bucket, MaxKeys: 1000}).promise()",
                ".then(data => {",
                "var deleteTasks = [];",
                "data.Contents.forEach(function(item){",
                "console.log('trying to delete: ', item.Key, bucket);",
                "deleteTasks.push(",
                "s3.deleteObject({",
                "Key: item.Key,",
                "Bucket: bucket}).promise());",
                "});",
                "return Promise.all(deleteTasks);",
                "})",
                ".then(done => {",
                "response.send(event, context, response.SUCCESS);",
                "});",
                "}",
                "else",
                "{",
                "download(sourceCodeZipUrl, function(data){",
                "s3.putObject({Key: objectKey,",
                "Bucket: bucket,",
                "ContentType: 'application/zip',",
                "ServerSideEncryption: 'AES256',",
                "Body: data }).promise()",
                ".then(r => codebuild.startBuild({projectName: event.ResourceProperties.ProjectName + '-initializer'}).promise())",
                ".then(r => {",
                "response.send(event, context, response.SUCCESS);",
                "});",
                "});",
                "}",
                "};",
                "function download(url, cb) {",
                "var data = [];",
                "var request = require('https').get(url, function(res) {",
                "",
                "res.on('data', function(chunk) {",
                "data.push(chunk);",
                "});",
                "res.on('end', function() {",
                "var buffer = Buffer.concat(data);",
                "cb(buffer);",
                "});",
                "});",
                "request.on('error', function(e) {",
                "console.log('Got error: ' + e.message);",
                "});",
                "}"
              ]
            ]
          }
        },
        "FunctionName": { "Fn::Sub": "${AWS::StackName}-initializer" },
        "Handler": "index.handler",
        "MemorySize": 128,
        "Role": { "Fn::GetAtt": [ "CodeInitializerRole", "Arn" ] },
        "Runtime": "nodejs8.10",
        "Timeout": 120
      }
    },
    "CodeInitializerRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [